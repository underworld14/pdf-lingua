FROM --platform=linux/amd64 izzadev/node22-with-pdf2htmlex:latest

# Next.js/Prisma app lives here
WORKDIR /app

# Set development environment
ENV NODE_ENV="development"

# Install pnpm
ARG PNPM_VERSION=10.10.0
RUN npm install -g pnpm@$PNPM_VERSION

# Prepare database directory
RUN mkdir -p /data
VOLUME /data

# Install basic development tools
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
    build-essential \
    openssl \
    python-is-python3 \
    vim \
    nano \
    git \
    && rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Setup for Next.js hot reloading
ENV WATCHPACK_POLLING=true
ENV CHOKIDAR_USEPOLLING=true

# Default database URL
ENV DATABASE_URL="file:///data/sqlite.db"

# Override the entrypoint from the base image
ENTRYPOINT []

# Create shell script for development startup
COPY ./docker-dev-entrypoint.sh /app/docker-dev-entrypoint.sh
RUN chmod +x /app/docker-dev-entrypoint.sh

# Start command for development
CMD ["/app/docker-dev-entrypoint.sh"]
